# Assistant History Implementation - Complete Documentation

## Overview
This document provides comprehensive technical documentation for the AI Assistant History tracking system implemented in the Travel HR Buddy / Nautilus One platform.

## Architecture

### System Components

```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend Layer                        │
├─────────────────────────────────────────────────────────────┤
│  • AssistantPage (/admin/assistant)                         │
│    - "Ver Histórico" button                                  │
│    - Existing chat interface                                 │
│                                                              │
│  • AssistantHistoryPage (/admin/assistant/history)          │
│    - Log display with cards                                  │
│    - Search/filter functionality                             │
│    - CSV export                                              │
└─────────────────────────────────────────────────────────────┘
                            ↓ ↑
┌─────────────────────────────────────────────────────────────┐
│                      Supabase Functions                      │
├─────────────────────────────────────────────────────────────┤
│  • assistant-query                                           │
│    - Processes user questions                                │
│    - Generates AI responses                                  │
│    - **NEW: Logs all interactions**                          │
│                                                              │
│  • assistant-logs (NEW)                                      │
│    - Fetches history for admins                              │
│    - Admin-only access control                               │
└─────────────────────────────────────────────────────────────┘
                            ↓ ↑
┌─────────────────────────────────────────────────────────────┐
│                       Database Layer                         │
├─────────────────────────────────────────────────────────────┤
│  • assistant_logs table (NEW)                                │
│    - Stores all interactions                                 │
│    - RLS policies for security                               │
│    - Performance indexes                                     │
└─────────────────────────────────────────────────────────────┘
```

## Database Schema

### Table: `assistant_logs`

```sql
CREATE TABLE public.assistant_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    user_email TEXT,
    question TEXT NOT NULL,
    answer TEXT,
    action TEXT,
    target TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Column Descriptions:**
- `id`: Unique identifier for each log entry
- `user_id`: Foreign key to auth.users (nullable for anonymous users)
- `user_email`: Email address of the user (stored separately for easier querying)
- `question`: The question/command asked by the user
- `answer`: The response generated by the assistant
- `action`: Type of action (navigation, query, info, error, etc.)
- `target`: Target URL for navigation actions
- `created_at`: Timestamp of when the interaction occurred

### Indexes

```sql
-- For filtering by user
CREATE INDEX idx_assistant_logs_user_id ON assistant_logs(user_id);

-- For sorting by date (most recent first)
CREATE INDEX idx_assistant_logs_created_at ON assistant_logs(created_at DESC);

-- For searching by email
CREATE INDEX idx_assistant_logs_user_email ON assistant_logs(user_email);
```

### Row Level Security (RLS) Policies

**Policy 1: Admin Access**
```sql
CREATE POLICY "Admins can view all assistant logs"
ON assistant_logs FOR SELECT TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM profiles
        WHERE profiles.id = auth.uid()
        AND profiles.role = 'admin'
    )
);
```

**Policy 2: User Self-Access**
```sql
CREATE POLICY "Users can view their own assistant logs"
ON assistant_logs FOR SELECT TO authenticated
USING (user_id = auth.uid());
```

**Policy 3: Logging Access**
```sql
CREATE POLICY "Authenticated users can insert assistant logs"
ON assistant_logs FOR INSERT TO authenticated
WITH CHECK (true);
```

## Backend Implementation

### Edge Function: `assistant-logs`

**Location:** `supabase/functions/assistant-logs/index.ts`

**Purpose:** Fetch all assistant logs (admin-only endpoint)

**Authentication Flow:**
1. Verify Authorization header is present
2. Validate user authentication via Supabase Auth
3. Check user has admin role in profiles table
4. Return 403 if not admin
5. Fetch all logs ordered by created_at DESC

**Response Format:**
```json
{
  "logs": [
    {
      "id": "uuid",
      "user_id": "uuid",
      "user_email": "user@example.com",
      "question": "criar checklist",
      "answer": "✅ Navegando para...",
      "action": "navigation",
      "target": "/admin/checklists",
      "created_at": "2025-10-12T05:30:00Z"
    }
  ],
  "total": 42
}
```

**Error Handling:**
- Returns 400 for general errors
- Returns 403 for unauthorized access
- Always includes empty logs array on error

### Edge Function: `assistant-query` (Enhanced)

**Location:** `supabase/functions/assistant-query/index.ts`

**New Feature: Automatic Logging**

Added `logQuery()` helper function:
```typescript
async function logQuery(
  supabase: any,
  userId: string | null,
  userEmail: string | null,
  question: string,
  answer: string,
  action?: string,
  target?: string
)
```

**Logging Points:**
1. After processing pending tasks query
2. After processing document query
3. After matching command patterns
4. After OpenAI response (with fallback)
5. In error handler

**User Information Extraction:**
```typescript
let userId: string | null = null;
let userEmail: string | null = null;
try {
  const { data: { user } } = await supabase.auth.getUser();
  if (user) {
    userId = user.id;
    userEmail = user.email || null;
  }
} catch (error) {
  console.warn("Could not fetch user info:", error);
}
```

**Logging is Non-Blocking:**
- Wrapped in try-catch
- Failures don't affect assistant functionality
- Errors logged to console only

## Frontend Implementation

### Component: `AssistantHistoryPage`

**Location:** `src/pages/admin/assistant-history.tsx`

**Features:**
1. **Real-time Search/Filter**
   - Filters questions, answers, and user emails
   - Case-insensitive matching
   - Updates immediately on input change

2. **CSV Export**
   - Proper CSV escaping (quotes, commas, newlines)
   - Strips HTML tags from answers
   - UTF-8 BOM for Excel compatibility
   - Filename includes date

3. **UI States**
   - Loading spinner during fetch
   - Error display with retry button
   - Empty state messages
   - Filter result count

**State Management:**
```typescript
const [logs, setLogs] = useState<AssistantLog[]>([]); // All logs
const [filteredLogs, setFilteredLogs] = useState<AssistantLog[]>([]); // Filtered
const [loading, setLoading] = useState(true);
const [searchTerm, setSearchTerm] = useState("");
const [error, setError] = useState<string | null>(null);
```

**CSV Export Implementation:**
```typescript
function escapeCSV(str: string): string {
  if (!str) return "";
  if (str.includes(",") || str.includes('"') || str.includes("\n")) {
    return `"${str.replace(/"/g, '""')}"`;
  }
  return str;
}

function stripHTML(html: string): string {
  const tmp = document.createElement("div");
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || "";
}
```

### Component: `AssistantPage` (Enhanced)

**Location:** `src/pages/admin/assistant.tsx`

**Changes:**
1. Added import for `useNavigate` from react-router-dom
2. Added import for `History` icon from lucide-react
3. Added navigate instance: `const navigate = useNavigate();`
4. Changed header structure to use flexbox with justify-between
5. Added "Ver Histórico" button with onClick handler

**Button Implementation:**
```tsx
<Button
  variant="outline"
  onClick={() => navigate("/admin/assistant/history")}
>
  <History className="w-4 h-4 mr-2" />
  Ver Histórico
</Button>
```

## Routing Configuration

**Location:** `src/App.tsx`

**Changes:**
1. Added lazy import:
   ```typescript
   const AssistantHistory = React.lazy(() => 
     import("./pages/admin/assistant-history")
   );
   ```

2. Added route:
   ```tsx
   <Route 
     path="/admin/assistant/history" 
     element={<AssistantHistory />} 
   />
   ```

## Usage Examples

### 1. Basic Usage (User Perspective)

1. User navigates to `/admin/assistant`
2. User asks: "criar checklist"
3. Assistant responds with navigation message
4. **Interaction is automatically logged to database**

### 2. Viewing History (Admin Perspective)

1. Admin clicks "Ver Histórico" button
2. Browser navigates to `/admin/assistant/history`
3. Page loads all logs via `assistant-logs` function
4. Admin sees card-based list of all interactions

### 3. Searching History

1. Admin types "checklist" in search box
2. List filters to show only matching entries
3. Matching happens on question, answer, and user email

### 4. Exporting to CSV

1. Admin clicks "Exportar CSV" button
2. Browser generates CSV with proper formatting
3. File downloads as `assistente-historico-2025-10-12.csv`

## Security Considerations

### Database Level
- RLS policies ensure admins see all, users see only their own
- Foreign key constraint maintains referential integrity
- CASCADE delete removes logs when user is deleted

### Application Level
- Admin role checked before displaying history page
- Authorization header required for all API calls
- User context validated on every request

### Data Privacy
- User emails stored for audit purposes
- Logs can be filtered per user
- No sensitive data stored (passwords, tokens, etc.)

## Performance Considerations

### Database
- Indexes on frequently queried columns
- DESC index on created_at for efficient recent-first queries
- Indexes on user_id and user_email for filtering

### Frontend
- Lazy loading of history page component
- Client-side filtering (no re-fetch on search)
- Debouncing not needed (controlled input)

### Backend
- Logs fetched once and cached in frontend state
- Non-blocking logging (doesn't slow down assistant)
- Error handling prevents cascading failures

## Monitoring and Maintenance

### Database Growth
- Monitor table size: `SELECT pg_size_pretty(pg_total_relation_size('assistant_logs'));`
- Consider archiving old logs (>6 months)
- Potential future: Add retention policy

### Error Tracking
- Log insertion failures logged to console
- Frontend displays errors to admins
- Retry mechanism available

### Analytics Opportunities
- Most asked questions
- Most active users
- Response time analysis
- Popular navigation targets
- Error rate tracking

## Future Enhancements

### Potential Features
1. **Pagination**: For large log volumes
2. **Date Range Filters**: Filter by date/time
3. **Advanced Analytics**: Charts and insights
4. **Export Formats**: JSON, Excel, PDF
5. **Real-time Updates**: WebSocket for live logs
6. **User Activity Heatmap**: Visualize usage patterns
7. **Question Clustering**: Group similar questions
8. **Response Quality Metrics**: Track user satisfaction

### Performance Improvements
1. **Server-side Filtering**: Move to backend for large datasets
2. **Caching**: Cache recent logs in Redis
3. **Compression**: Compress old logs
4. **Archival**: Move old data to cold storage

## Testing Checklist

- [ ] Admin can view all logs
- [ ] Non-admin users see 403 error
- [ ] Search filters correctly
- [ ] CSV export works with special characters
- [ ] Logs appear immediately after asking question
- [ ] Error handling works when database is unavailable
- [ ] RLS policies enforced correctly
- [ ] Indexes improve query performance
- [ ] Navigation button appears on assistant page
- [ ] History page loads without errors

## Troubleshooting

### Issue: Logs Not Appearing
**Check:**
1. Is RLS enabled on assistant_logs table?
2. Are the policies created correctly?
3. Is the assistant-query function logging?
4. Check browser console for errors

### Issue: 403 Forbidden Error
**Check:**
1. Is user authenticated?
2. Does user have admin role in profiles table?
3. Is Authorization header being sent?

### Issue: CSV Export Fails
**Check:**
1. Browser console for JavaScript errors
2. Are there any null/undefined values?
3. HTML content properly stripped?

## Conclusion

The Assistant History system provides comprehensive logging and analysis capabilities for the AI Assistant. It maintains high security standards while offering powerful search and export features for administrators.
