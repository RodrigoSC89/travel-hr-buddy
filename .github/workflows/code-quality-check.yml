name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint
      continue-on-error: true
    
    - name: Run tests
      run: npm run test
      continue-on-error: true
    
    - name: Run tests with coverage
      run: npm run test:coverage
      continue-on-error: true
    
    - name: Build project
      run: npm run build
    
    - name: Check for hardcoded tokens
      run: |
        echo "ðŸ” Scanning for hardcoded tokens..."
        
        # Check for Bearer tokens
        if grep -r "Bearer " src/ --include="*.ts" --include="*.tsx" | grep -v "Authorization.*Bearer"; then
          echo "âŒ Found hardcoded Bearer tokens!"
          exit 1
        else
          echo "âœ… No hardcoded Bearer tokens found"
        fi
        
        # Check for Supabase URLs
        if grep -r "supabase\.co" src/ --include="*.ts" --include="*.tsx" | grep -v "import\|VITE_SUPABASE_URL\|env\."; then
          echo "âš ï¸ Found potential hardcoded Supabase URLs"
          grep -r "supabase\.co" src/ --include="*.ts" --include="*.tsx" | grep -v "import\|VITE_SUPABASE_URL\|env\."
        else
          echo "âœ… No hardcoded Supabase URLs found"
        fi
    
    - name: Check TypeScript any usage
      run: |
        echo "ðŸ” Checking for 'any' type usage..."
        ANY_COUNT=$(grep -r ": any" src/ --include="*.ts" --include="*.tsx" | wc -l || echo "0")
        echo "Found $ANY_COUNT occurrences of 'any' type"
        
        if [ "$ANY_COUNT" -gt 300 ]; then
          echo "âš ï¸ Warning: High usage of 'any' type ($ANY_COUNT occurrences)"
          echo "Consider adding proper type definitions"
        else
          echo "âœ… 'any' type usage is within acceptable range"
        fi
    
    - name: Check console usage
      run: |
        echo "ðŸ” Checking for console.log/error usage..."
        CONSOLE_COUNT=$(grep -r "console\." src/ --include="*.ts" --include="*.tsx" | grep -v "eslint-disable\|// console" | wc -l || echo "0")
        echo "Found $CONSOLE_COUNT console statements"
        
        if [ "$CONSOLE_COUNT" -gt 50 ]; then
          echo "âš ï¸ Warning: High console usage ($CONSOLE_COUNT occurrences)"
          echo "Consider using the centralized logger instead"
        else
          echo "âœ… Console usage is acceptable"
        fi
    
    - name: Check for .env files
      run: |
        echo "ðŸ” Checking for committed .env files..."
        if find . -name ".env" -not -path "./node_modules/*" -not -path "./.git/*" | grep .; then
          echo "âŒ Found .env files in repository!"
          exit 1
        else
          echo "âœ… No .env files found in repository"
        fi
    
    - name: Upload coverage reports
      if: matrix.node-version == '22.x'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        if-no-files-found: ignore
    
    - name: Summary
      if: always()
      run: |
        echo "## Code Quality Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Build: Success" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Tests: Check test results above" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”’ Security: Token scan completed" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ Code Quality: Metrics checked" >> $GITHUB_STEP_SUMMARY
