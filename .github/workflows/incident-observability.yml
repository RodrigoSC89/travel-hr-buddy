name: "Nautilus One - Observability and Incident Response"

on:
  schedule:
    - cron: "*/30 * * * *" # a cada 30 minutos
  workflow_dispatch:

jobs:
  observability:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Run AI Insight Reporter Diagnostics
        run: node src/lib/ai/insight-reporter.js

      - name: Send Telemetry via Supabase
        run: |
          echo "ğŸ“¡ Enviando telemetria para Supabase Edge Functions..."
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/log_incident" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -d '{"module":"CI","severity":"info","message":"Rotina de observabilidade concluÃ­da."}'

      - name: Notify via MQTT
        run: node -e "import('./src/lib/mqtt/secure-client.js').then(m=>m.initSecureMQTT()).then(c=>c.publish('nautilus/alerts','{\"severity\":\"info\",\"message\":\"Observability completed\"}'))"
