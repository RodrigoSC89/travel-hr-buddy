# Template Generation API - Integration Guide

## Quick Start: Using the API

This guide shows how to integrate the `generate-template` Supabase Edge Function into your existing components.

## Basic Integration Example

### 1. Simple Function Call

```typescript
import { supabase } from '@/integrations/supabase/client';

async function generateTemplateContent(title: string) {
  const { data, error } = await supabase.functions.invoke('generate-template', {
    body: { title }
  });

  if (error) {
    console.error('Error:', error);
    return null;
  }

  return data.content;
}

// Usage
const content = await generateTemplateContent('Inspeção de Dynamic Positioning');
console.log(content);
```

## Integration with Existing Template Manager

### Adding "Generate with AI" Button to Template Manager

You can enhance the existing `/src/components/templates/template-manager.tsx` component:

```typescript
import { supabase } from '@/integrations/supabase/client';
import { Sparkles } from 'lucide-react';

// Inside your TemplateManager component, add this function:
const [generating, setGenerating] = useState(false);

async function generateTemplateWithAI(title: string) {
  setGenerating(true);
  try {
    const { data, error } = await supabase.functions.invoke('generate-template', {
      body: { title }
    });

    if (error) throw error;

    // Add the generated template to your templates list
    const newTemplate: Template = {
      id: crypto.randomUUID(),
      name: title,
      description: `Generated by AI on ${new Date().toLocaleDateString()}`,
      category: 'maritime',
      type: 'document',
      createdBy: 'AI Assistant',
      createdAt: new Date(),
      usageCount: 0,
      isPublic: false,
      tags: ['ai-generated', 'maritime'],
      content: data.content,
    };

    setTemplates([newTemplate, ...templates]);
    
    toast({
      title: 'Template gerado com sucesso!',
      description: 'O template foi criado e está pronto para uso.',
    });
  } catch (error) {
    console.error('Error generating template:', error);
    toast({
      title: 'Erro ao gerar template',
      description: 'Ocorreu um erro ao gerar o template. Tente novamente.',
      variant: 'destructive',
    });
  } finally {
    setGenerating(false);
  }
}

// Add this button to your UI:
<Button 
  onClick={() => generateTemplateWithAI(templateTitle)}
  disabled={generating}
>
  <Sparkles className="h-4 w-4 mr-2" />
  {generating ? 'Gerando...' : 'Gerar com IA'}
</Button>
```

## Integration with TipTap Editor

### Example: Maritime Document Editor with AI Generation

```typescript
import { useState } from 'react';
import { useEditor } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { supabase } from '@/integrations/supabase/client';
import { toast } from '@/hooks/use-toast';
import { Sparkles, Loader2 } from 'lucide-react';

function MaritimeTemplateEditor() {
  const [title, setTitle] = useState('');
  const [generating, setGenerating] = useState(false);

  const editor = useEditor({
    extensions: [StarterKit],
    content: '<p>Digite o título do template e clique em "Gerar com IA"</p>',
  });

  async function generateAndLoad() {
    if (!title.trim()) {
      toast({
        title: 'Título obrigatório',
        description: 'Por favor, digite um título para o template.',
        variant: 'destructive',
      });
      return;
    }

    setGenerating(true);
    try {
      const { data, error } = await supabase.functions.invoke('generate-template', {
        body: { title: title.trim() }
      });

      if (error) throw error;

      // Load generated content into TipTap editor
      editor?.commands.setContent(data.content);

      toast({
        title: 'Template gerado!',
        description: 'O conteúdo foi carregado no editor. Você pode editá-lo agora.',
      });
    } catch (error) {
      console.error('Error:', error);
      toast({
        title: 'Erro ao gerar template',
        description: 'Tente novamente mais tarde.',
        variant: 'destructive',
      });
    } finally {
      setGenerating(false);
    }
  }

  return (
    <div className="space-y-4">
      <div className="flex gap-2">
        <Input
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          placeholder="Ex: Inspeção de Dynamic Positioning - PSV"
          className="flex-1"
        />
        <Button 
          onClick={generateAndLoad}
          disabled={generating || !title.trim()}
        >
          {generating ? (
            <>
              <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              Gerando...
            </>
          ) : (
            <>
              <Sparkles className="h-4 w-4 mr-2" />
              Gerar com IA
            </>
          )}
        </Button>
      </div>

      {/* TipTap Editor */}
      <div className="border rounded-lg p-4 min-h-[400px]">
        {editor && <EditorContent editor={editor} />}
      </div>
    </div>
  );
}
```

## Integration with Reservation Templates

### Enhancing `/src/components/reservations/reservation-templates.tsx`

```typescript
import { supabase } from '@/integrations/supabase/client';
import { Sparkles } from 'lucide-react';

// Inside your ReservationTemplates component:
async function generateReservationTemplate(type: string, name: string) {
  const title = `Template de ${type}: ${name}`;
  
  try {
    const { data, error } = await supabase.functions.invoke('generate-template', {
      body: { title }
    });

    if (error) throw error;

    // Parse generated content and create reservation template
    const newTemplate = {
      id: crypto.randomUUID(),
      name,
      template_type: type,
      template_data: {
        title: name,
        description: data.content,
        reservation_type: type,
        // ... other fields
      },
      is_public: false,
      created_by: user.id,
      created_at: new Date().toISOString(),
    };

    // Save to Supabase
    await supabase
      .from('reservation_templates')
      .insert(newTemplate);

    toast({
      title: 'Template criado com sucesso!',
      description: 'Template de reserva gerado e salvo.',
    });
  } catch (error) {
    console.error('Error:', error);
    toast({
      title: 'Erro ao criar template',
      variant: 'destructive',
    });
  }
}
```

## Complete Example: Template Creation Modal

### Full-featured component with AI generation

```typescript
import { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { supabase } from '@/integrations/supabase/client';
import { toast } from '@/hooks/use-toast';
import { Sparkles, Loader2, Save } from 'lucide-react';

interface CreateTemplateModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

export function CreateTemplateModal({ isOpen, onClose, onSuccess }: CreateTemplateModalProps) {
  const [title, setTitle] = useState('');
  const [content, setContent] = useState('');
  const [generating, setGenerating] = useState(false);
  const [saving, setSaving] = useState(false);

  async function handleGenerate() {
    if (!title.trim()) {
      toast({
        title: 'Título obrigatório',
        description: 'Digite um título para gerar o template.',
        variant: 'destructive',
      });
      return;
    }

    setGenerating(true);
    try {
      const { data, error } = await supabase.functions.invoke('generate-template', {
        body: { title: title.trim() }
      });

      if (error) throw error;

      setContent(data.content);
      
      toast({
        title: 'Template gerado!',
        description: 'Você pode editar o conteúdo antes de salvar.',
      });
    } catch (error) {
      console.error('Error:', error);
      toast({
        title: 'Erro ao gerar template',
        description: 'Tente novamente mais tarde.',
        variant: 'destructive',
      });
    } finally {
      setGenerating(false);
    }
  }

  async function handleSave() {
    if (!title.trim() || !content.trim()) {
      toast({
        title: 'Campos obrigatórios',
        description: 'Preencha o título e o conteúdo.',
        variant: 'destructive',
      });
      return;
    }

    setSaving(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) throw new Error('User not authenticated');

      const { error } = await supabase
        .from('reservation_templates')
        .insert({
          name: title.trim(),
          template_type: 'maritime',
          template_data: {
            title: title.trim(),
            description: content,
            // Add other relevant fields
          },
          is_public: false,
          created_by: user.id,
        });

      if (error) throw error;

      toast({
        title: 'Template salvo!',
        description: 'O template foi salvo com sucesso.',
      });

      onSuccess();
      onClose();
      
      // Reset form
      setTitle('');
      setContent('');
    } catch (error) {
      console.error('Error:', error);
      toast({
        title: 'Erro ao salvar template',
        description: 'Ocorreu um erro ao salvar. Tente novamente.',
        variant: 'destructive',
      });
    } finally {
      setSaving(false);
    }
  }

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Criar Novo Template</DialogTitle>
        </DialogHeader>

        <div className="space-y-4 mt-4">
          <div className="space-y-2">
            <Label htmlFor="title">Título do Template *</Label>
            <div className="flex gap-2">
              <Input
                id="title"
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                placeholder="Ex: Inspeção de Dynamic Positioning - PSV"
                className="flex-1"
              />
              <Button
                onClick={handleGenerate}
                disabled={generating || !title.trim()}
                variant="outline"
              >
                {generating ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Gerando...
                  </>
                ) : (
                  <>
                    <Sparkles className="h-4 w-4 mr-2" />
                    Gerar com IA
                  </>
                )}
              </Button>
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="content">Conteúdo do Template *</Label>
            <Textarea
              id="content"
              value={content}
              onChange={(e) => setContent(e.target.value)}
              placeholder="Conteúdo do template será gerado aqui ou você pode digitar manualmente..."
              rows={15}
              className="font-mono text-sm"
            />
          </div>

          <div className="flex justify-end gap-2">
            <Button variant="outline" onClick={onClose}>
              Cancelar
            </Button>
            <Button
              onClick={handleSave}
              disabled={saving || !title.trim() || !content.trim()}
            >
              {saving ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Salvando...
                </>
              ) : (
                <>
                  <Save className="h-4 w-4 mr-2" />
                  Salvar Template
                </>
              )}
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

## Usage in Different Contexts

### 1. Maritime Operations
```typescript
await generateTemplateContent('Inspeção de Dynamic Positioning - PSV');
await generateTemplateContent('Rotina de Máquinas - OSV');
await generateTemplateContent('Checklist de Segurança - AHTS');
```

### 2. HR Documents
```typescript
await generateTemplateContent('Avaliação de Desempenho Marítimo');
await generateTemplateContent('Termo de Embarque');
await generateTemplateContent('Certificado de Conclusão STCW');
```

### 3. Operational Reports
```typescript
await generateTemplateContent('Relatório de Operação Offshore');
await generateTemplateContent('Relatório de Incidentes de Segurança');
await generateTemplateContent('Relatório de Manutenção Preventiva');
```

## Error Handling Best Practices

```typescript
async function generateTemplateWithErrorHandling(title: string) {
  try {
    const { data, error } = await supabase.functions.invoke('generate-template', {
      body: { title }
    });

    if (error) {
      // Handle specific error cases
      if (error.message.includes('OPENAI_API_KEY')) {
        toast({
          title: 'Configuração incompleta',
          description: 'A chave da API OpenAI não está configurada.',
          variant: 'destructive',
        });
        return null;
      }

      if (error.message.includes('429')) {
        toast({
          title: 'Limite de requisições atingido',
          description: 'Por favor, aguarde alguns minutos antes de tentar novamente.',
          variant: 'destructive',
        });
        return null;
      }

      throw error;
    }

    return data.content;
  } catch (error) {
    console.error('Unexpected error:', error);
    toast({
      title: 'Erro inesperado',
      description: 'Ocorreu um erro ao gerar o template. Tente novamente.',
      variant: 'destructive',
    });
    return null;
  }
}
```

## Testing the Integration

### Manual Testing Steps

1. **Navigate to your template management page**
2. **Click "Create New Template" or "Generate with AI"**
3. **Enter a title**: e.g., "Inspeção de Dynamic Positioning - PSV"
4. **Click "Generate"** and wait 2-5 seconds
5. **Verify the generated content** appears in the editor
6. **Edit if needed** and save to Supabase

### Expected Output Example

```
# Inspeção de Dynamic Positioning - PSV

## 1. Informações Gerais

[CAMPO EDITÁVEL: Nome da Embarcação]
[CAMPO EDITÁVEL: Número IMO]
[CAMPO EDITÁVEL: Data da Inspeção]

## 2. Sistema de Posicionamento Dinâmico

### 2.1 Verificação de Sensores
- [CAMPO EDITÁVEL: DGPS Status]
- [CAMPO EDITÁVEL: Gyro Compass Status]
- [CAMPO EDITÁVEL: Wind Sensor Status]

### 2.2 Teste de Redundância
[CAMPO EDITÁVEL: Resultado dos testes de redundância]

## 3. Observações e Recomendações

[CAMPO EDITÁVEL: Observações gerais]

---
Inspetor: [CAMPO EDITÁVEL: Nome do Inspetor]
Assinatura: ________________
```

## Next Steps

1. **Deploy the function** to Supabase production
2. **Update your UI components** with the integration code
3. **Test thoroughly** with different template types
4. **Monitor usage** and API costs
5. **Gather user feedback** for improvements

## Support and Documentation

- **Main Documentation**: `/supabase/functions/generate-template/README.md`
- **Implementation Summary**: `/TEMPLATE_GENERATION_API_IMPLEMENTATION.md`
- **Tests**: `/src/tests/functions/generate-template.test.ts`

## Performance Tips

1. **Cache frequently used templates** to avoid repeated API calls
2. **Implement rate limiting** on the frontend to prevent abuse
3. **Show loading indicators** to improve UX during generation
4. **Allow editing** of generated content before saving
5. **Store templates** in Supabase for reuse
