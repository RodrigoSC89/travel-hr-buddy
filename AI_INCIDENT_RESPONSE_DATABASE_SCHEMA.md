# AI Incident Response & Resilience Integration - Database Schema

## Supabase Table: `incident_reports`

This table stores automated incident reports generated by the AI Incident Response system.

### SQL Schema

```sql
create table incident_reports (
  id uuid primary key default uuid_generate_v4(),
  timestamp timestamptz not null,
  type text,
  description text,
  level text,
  score float,
  recommendation text
);

-- Add index for faster queries
create index idx_incident_reports_timestamp on incident_reports(timestamp desc);
create index idx_incident_reports_level on incident_reports(level);

-- Enable Row Level Security
alter table incident_reports enable row level security;

-- Allow authenticated users to read incident reports
create policy "Allow authenticated users to read incident reports"
  on incident_reports
  for select
  to authenticated
  using (true);

-- Allow service role to insert incident reports
create policy "Allow service role to insert incident reports"
  on incident_reports
  for insert
  to authenticated
  with check (true);
```

### Table Columns

| Column | Type | Description |
|--------|------|-------------|
| `id` | `uuid` | Unique identifier for the incident report (auto-generated) |
| `timestamp` | `timestamptz` | When the incident was detected |
| `type` | `text` | Type of incident (e.g., "Operational", "DP Loss", "ISPS") |
| `description` | `text` | Human-readable description of the incident |
| `level` | `text` | Compliance level: "Conforme", "Risco", or "NÃ£o Conforme" |
| `score` | `float` | Compliance score (0.0 - 1.0) |
| `recommendation` | `text` | AI-generated recommendation for remediation |

### Setup Instructions

1. Execute the SQL schema above in your Supabase SQL editor
2. Ensure RLS policies are configured appropriately for your security requirements
3. Verify the table exists and is accessible from your application

### Real-time Subscriptions

The `IncidentResponsePanel` component subscribes to real-time updates on this table using Supabase Realtime:

```typescript
const subscription = supabase
  .channel("incident_watch")
  .on("postgres_changes", { 
    event: "INSERT", 
    schema: "public", 
    table: "incident_reports" 
  }, fetchIncidents)
  .subscribe();
```

This allows the dashboard to automatically update when new incidents are detected.

### MQTT Integration

In addition to Supabase storage, incidents are also published to MQTT topics for real-time alerting:

- **Topic**: `nautilus/incidents/alert`
- **Format**: JSON
- **Broker**: Configured via `VITE_MQTT_URL` environment variable

### Environment Variables

Ensure the following environment variables are configured:

```env
# Supabase
VITE_SUPABASE_URL=https://YOUR_PROJECT.supabase.co
VITE_SUPABASE_ANON_KEY=YOUR_ANON_KEY

# MQTT (optional, for incident alerting)
VITE_MQTT_URL=wss://broker.emqx.io:8084/mqtt
```

### Testing

To test the incident response system, you can manually insert a test incident:

```typescript
import { handleIncident } from "@/lib/incidents/ai-incident-response";

// Simulate an incident
await handleIncident({
  type: "DP Loss",
  description: "Dynamic positioning system lost reference",
  data: {
    dpLoss: true,
    sensorMisalignment: false,
  }
});
```

This will create an incident report in Supabase and publish it to the MQTT broker (if configured).
