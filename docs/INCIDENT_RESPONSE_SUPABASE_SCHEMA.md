# Incident Response Supabase Schema

## Overview
This schema supports the Incident Response AI Core system for Nautilus One, providing automated incident detection, compliance tracking, and real-time monitoring capabilities.

## Table: `incident_reports`

### Description
Stores all incident reports generated by the Nautilus One system modules with risk assessment and compliance mapping.

### Schema Definition

```sql
-- Create incident_reports table
CREATE TABLE IF NOT EXISTS public.incident_reports (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  module TEXT,
  type TEXT,
  severity TEXT,
  message TEXT,
  riskScore NUMERIC,
  compliance TEXT[]
);

-- Create indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_incident_reports_timestamp 
  ON public.incident_reports(timestamp DESC);

CREATE INDEX IF NOT EXISTS idx_incident_reports_severity 
  ON public.incident_reports(severity);

CREATE INDEX IF NOT EXISTS idx_incident_reports_module 
  ON public.incident_reports(module);

-- Enable Row Level Security
ALTER TABLE public.incident_reports ENABLE ROW LEVEL SECURITY;

-- Create policy for authenticated users to read incident reports
CREATE POLICY "Allow authenticated users to read incident reports"
  ON public.incident_reports
  FOR SELECT
  TO authenticated
  USING (true);

-- Create policy for authenticated users to insert incident reports
CREATE POLICY "Allow authenticated users to insert incident reports"
  ON public.incident_reports
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- Enable Realtime for incident_reports table
ALTER PUBLICATION supabase_realtime ADD TABLE public.incident_reports;
```

## Column Descriptions

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Unique identifier for each incident report (auto-generated) |
| `timestamp` | TIMESTAMPTZ | Timestamp when the incident was reported |
| `module` | TEXT | Nautilus module that reported the incident (e.g., "DP Advisor", "Maintenance Orchestrator") |
| `type` | TEXT | Type of incident (e.g., "DP Failure", "Equipment Failure", "Safety Alert") |
| `severity` | TEXT | Severity level: "Critical", "Major", "Moderate", or "Minor" |
| `message` | TEXT | Detailed description of the incident |
| `riskScore` | NUMERIC | Calculated risk score (0.0 to 1.0) based on severity |
| `compliance` | TEXT[] | Array of applicable maritime compliance standards |

## Risk Score Mapping

| Severity | Risk Score |
|----------|-----------|
| Critical | 0.9 |
| Major    | 0.7 |
| Moderate | 0.4 |
| Minor    | 0.2 |

## Compliance Standards

The system automatically maps incidents to relevant maritime compliance standards:

### ISM Code (International Safety Management)
- **ISM Code 9.1**: Accident and Non-conformity Reporting
- **ISM Code 10.2**: Maintenance of Ship and Equipment
- **ISM Code 10.3**: Inspection and Reporting of Deficiencies

### ISPS Code (International Ship and Port Facility Security)
- **ISPS Code Part B-16**: Security Incident Procedures

### IMCA Guidelines
- **IMCA M103**: General guidelines
- **IMCA M109**: DP Incident Reporting
- **IMCA M140**: DP Operations
- **IMCA M166**: Operational guidelines
- **IMCA M254**: DP Electrical Power and Control Systems

### Other Standards
- **IMO MSC.428(98)**: International Maritime Organization standards
- **NORMAM 101**: Brazilian maritime standards
- **MTS Guidelines**: General maritime technology standards

## Usage Example

### Insert an Incident Report

```typescript
import { handleIncidentReport } from "@/lib/ai/incident-response-core";

// Report a DP failure
const response = await handleIncidentReport({
  type: "DP Failure",
  severity: "Critical",
  message: "DP system lost position reference - GPS failure",
  module: "DP Advisor"
});

// Response includes:
// {
//   id: "uuid",
//   timestamp: "2025-10-21T19:56:46.786Z",
//   module: "DP Advisor",
//   type: "DP Failure",
//   severity: "Critical",
//   message: "DP system lost position reference - GPS failure",
//   riskScore: 0.9,
//   compliance: ["ISM Code 9.1", "ISM Code 10.2", "IMCA M109", "IMCA M254"]
// }
```

### Query Incident Reports

```typescript
import { supabase } from "@/integrations/supabase/client";

// Get recent critical incidents
const { data, error } = await supabase
  .from("incident_reports")
  .select("*")
  .eq("severity", "Critical")
  .order("timestamp", { ascending: false })
  .limit(10);
```

### Real-time Subscription

```typescript
import { supabase } from "@/integrations/supabase/client";

// Subscribe to new incidents
const channel = supabase
  .channel("incident_reports_changes")
  .on(
    "postgres_changes",
    {
      event: "INSERT",
      schema: "public",
      table: "incident_reports",
    },
    (payload) => {
      console.log("New incident:", payload.new);
    }
  )
  .subscribe();
```

## Integration Points

The Incident Response AI system integrates with:

1. **DP Advisor** - Reports DP failures and operational anomalies
2. **Maintenance Orchestrator** - Reports maintenance delays and equipment issues
3. **Control Hub** - Reports safety alerts and system events
4. **SGSO Module** - Integrates with safety management system
5. **MQTT Broker** - Publishes real-time alerts to `nautilus/incidents/alert` topic

## Security Considerations

- Row Level Security (RLS) is enabled on the `incident_reports` table
- Only authenticated users can read and insert incident reports
- Real-time subscriptions require authenticated connections
- MQTT alerts are published to a secured broker (configure `VITE_MQTT_URL`)

## Maintenance

- Regular cleanup of old incident reports may be needed based on retention policies
- Monitor index performance and add additional indexes as query patterns evolve
- Review compliance standard mappings periodically to ensure alignment with latest regulations

## Post-Deployment Setup

After deploying this schema to Supabase:

1. Run the SQL script in the Supabase SQL editor
2. Verify that Row Level Security policies are active
3. Confirm that Realtime is enabled for the table
4. Test incident reporting from the application
5. Verify MQTT alerts are being published (if MQTT is configured)

## Support

For issues or questions regarding the Incident Response AI system:
- Review the implementation in `src/lib/ai/incident-response-core.ts`
- Check the compliance components in `src/components/compliance/`
- Consult the Compliance Hub at `/compliance` in the application
