# Incident Response Supabase Schema

This document describes the database schema required for the Incident Response AI & Maritime Compliance Core system.

## Table: incident_reports

This table stores all incident reports generated by the Nautilus One system, including incidents from DP Advisor, Maintenance Orchestrator, Control Hub, SGSO Module, and any other integrated modules.

### SQL Schema

```sql
create table incident_reports (
  id uuid primary key default uuid_generate_v4(),
  timestamp timestamptz not null,
  module text,
  type text,
  severity text,
  message text,
  riskScore numeric,
  compliance text[]
);
```

### Column Descriptions

- **id**: Unique identifier for each incident report (UUID, auto-generated)
- **timestamp**: When the incident occurred (timestamp with timezone)
- **module**: The source module that reported the incident (e.g., "DP Advisor", "Maintenance Orchestrator")
- **type**: Category of incident (e.g., "DP Failure", "Cyber Breach", "Maintenance Delay", "Safety Alert")
- **severity**: Severity level (e.g., "Critical", "Major", "Moderate", "Minor")
- **message**: Detailed description of the incident
- **riskScore**: Calculated risk score (numeric value between 0 and 1)
- **compliance**: Array of related maritime compliance standards (e.g., ["IMCA M109", "ISM Code 10.2"])

### Indexes (Recommended)

For optimal query performance, consider adding these indexes:

```sql
-- Index for querying by timestamp
create index idx_incident_reports_timestamp on incident_reports(timestamp desc);

-- Index for querying by module
create index idx_incident_reports_module on incident_reports(module);

-- Index for querying by severity
create index idx_incident_reports_severity on incident_reports(severity);

-- Index for querying by type
create index idx_incident_reports_type on incident_reports(type);
```

### Row Level Security (RLS)

If using Row Level Security in Supabase, you may want to enable policies:

```sql
-- Enable RLS
alter table incident_reports enable row level security;

-- Policy: Allow authenticated users to read all incidents
create policy "Allow authenticated users to read incidents"
  on incident_reports for select
  using (auth.role() = 'authenticated');

-- Policy: Allow authenticated users to insert incidents
create policy "Allow authenticated users to insert incidents"
  on incident_reports for insert
  with check (auth.role() = 'authenticated');
```

## Realtime Subscriptions

The ComplianceReporter component uses Supabase Realtime to automatically update when new incidents are reported. Ensure that Realtime is enabled for the `incident_reports` table in your Supabase project.

## MQTT Integration

The system publishes incident alerts to the MQTT topic `nautilus/incidents/alert`. Ensure you have configured the `VITE_MQTT_URL` environment variable with your MQTT broker URL.

## Compliance Standards Mapping

The system automatically maps incident types to the following maritime compliance standards:

### DP Failure
- IMCA M109 (Guidelines for DP Operations)
- IMCA M254 (DP Incident Reporting)
- ISM Code 10.2 (Maintenance of Ship and Equipment)

### Cyber Breach
- ISPS Code Part B-16 (Ship Security Alert System)
- IMO MSC.428(98) (Maritime Cyber Risk Management)

### Maintenance Delay
- IMCA M140 (Planned Maintenance Systems)
- NORMAM 101 (Brazilian Maritime Regulations)
- ISM Code 10.3 (Documentation)

### Safety Alert
- IMCA M103 (Safety Culture)
- IMCA M166 (Safety Management Systems)
- ISM Code 9.1 (Reports and Analysis of Non-conformities)

### Default (Other Types)
- MTS Guidelines (Marine Technology Society)
- ISM Code (General)

## Usage Example

```typescript
import { handleIncidentReport } from "@/lib/ai/incident-response-core";

// Report a critical DP failure
await handleIncidentReport({
  type: "DP Failure",
  severity: "Critical",
  message: "DP system lost position reference - GPS failure",
  module: "DP Advisor"
});

// Returns:
// {
//   riskScore: 0.9,
//   compliance: ["IMCA M109", "IMCA M254", "ISM Code 10.2"]
// }
```

## Post-Installation Steps

1. Apply the SQL schema to your Supabase project
2. Configure environment variable: `VITE_MQTT_URL=<your-mqtt-broker-url>`
3. Enable Realtime for the `incident_reports` table in Supabase Dashboard
4. Test the incident reporting system by navigating to `/compliance`

## Troubleshooting

### Incidents not appearing in the UI
- Check that the `incident_reports` table exists in Supabase
- Verify that Realtime is enabled for the table
- Check browser console for errors

### MQTT alerts not publishing
- Verify `VITE_MQTT_URL` is configured correctly
- Check MQTT broker connectivity
- Review browser console for connection errors

### Compliance standards not mapping correctly
- Ensure the incident `type` matches one of the predefined types in `matchStandards()` function
- Custom incident types will default to "MTS Guidelines" and "ISM Code"
